<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Reset Password</title>
	<style>
		:root {
			--bg: #f5f7fb;
			--card-bg: #ffffff;
			--primary: #2563eb;
			--primary-dark: #1d4ed8;
			--text: #1f2937;
			--muted: #6b7280;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			min-height: 100vh;
			font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
			background: radial-gradient(circle at top, #eef2ff, var(--bg));
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--text);
		}

		.card {
			width: min(360px, 92vw);
			padding: 32px;
			background: var(--card-bg);
			border-radius: 16px;
			box-shadow: 0 15px 35px rgba(37, 99, 235, 0.12);
			text-align: center;
		}

		h1 {
			margin: 0 0 8px;
			font-size: 1.4rem;
		}

		p {
			margin: 0 0 24px;
			font-size: 0.9rem;
			color: var(--muted);
		}

		label {
			display: block;
			text-align: left;
			font-size: 0.85rem;
			font-weight: 600;
			margin-bottom: 6px;
		}

		input {
			width: 100%;
			padding: 12px 14px;
			border-radius: 10px;
			border: 1px solid #e5e7eb;
			background-color: #f9fafb;
			font-size: 0.95rem;
			margin-bottom: 18px;
			transition: border 0.2s ease, background 0.2s ease;
		}

		input:focus {
			outline: none;
			border-color: var(--primary);
			background-color: #fff;
		}

		button {
			width: 100%;
			padding: 13px 16px;
			border: none;
			border-radius: 999px;
			font-size: 1rem;
			font-weight: 600;
			color: #fff;
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
			cursor: pointer;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		button:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}

		button:not(:disabled):hover {
			transform: translateY(-1px);
			box-shadow: 0 12px 20px rgba(37, 99, 235, 0.25);
		}

		.status {
			margin-top: 16px;
			min-height: 20px;
			font-size: 0.9rem;
		}
	</style>
</head>

<body>
	<main class="card">
		<h1>Create New Password</h1>
		<p>Enter and confirm your new password to finish resetting your account.</p>

		<form id="reset-form" data-endpoint="/api/v1/users/resetPassword">
			<label for="password">New Password</label>
			<input type="password" id="password" name="password" placeholder="••••••••" required minlength="8">

			<label for="passwordConfirm">Confirm Password</label>
			<input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="••••••••" required minlength="8">

			<button type="submit" id="submit-btn">Update Password</button>
			<div class="status" id="status"></div>
		</form>
	</main>

	<script>
		const form = document.getElementById("reset-form");
		const statusText = document.getElementById("status");
		const submitBtn = document.getElementById("submit-btn");
		const passwordInput = document.getElementById("password");
		const confirmInput = document.getElementById("passwordConfirm");

		const MATCH_ERROR = "Passwords must match.";

		const passwordsMatch = () => passwordInput.value === confirmInput.value;

		const syncValidation = () => {
			if (!passwordsMatch()) {
				confirmInput.setCustomValidity(MATCH_ERROR);
				statusText.textContent = MATCH_ERROR;
				statusText.style.color = "#dc2626";
				submitBtn.disabled = true;
			} else {
				confirmInput.setCustomValidity("");
				statusText.textContent = "";
				statusText.style.color = "";
				submitBtn.disabled = false;
			}
		};

		passwordInput.addEventListener("input", syncValidation);
		confirmInput.addEventListener("input", syncValidation);

		const urlParams = new URLSearchParams(window.location.search);
		const token = urlParams.get("token") || window.location.pathname.split("/").filter(Boolean).pop();

		form.addEventListener("submit", async (event) => {
			event.preventDefault();
			syncValidation();
			if (!passwordsMatch()) {
				confirmInput.reportValidity();
				return;
			}
			statusText.textContent = "";

			const { password, passwordConfirm } = Object.fromEntries(new FormData(form));

			const endpoint = token
				? `${form.dataset.endpoint}/${token}`
				: form.dataset.endpoint;

			submitBtn.disabled = true;
			submitBtn.textContent = "Sending...";

			try {
				const response = await fetch(endpoint, {
					method: "PATCH",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({ password, passwordConfirm }),
				});

				const result = await response.json().catch(() => ({}));
				if (!response.ok) {
					throw new Error(result.message || "Unable to update password");
				}

				statusText.textContent = "Password updated successfully. You can log in now.";
				statusText.style.color = "#059669";
				form.reset();
			} catch (error) {
				statusText.textContent = error.message;
				statusText.style.color = "#dc2626";
			} finally {
				submitBtn.disabled = false;
				submitBtn.textContent = "Update Password";
			}
		});
	</script>
</body>

</html>
